import nmap 
import socket

SUBNET_MASK = '24'

def subnet_ip_scan(nm, subnet_ip='192.168.0.1', mask='24', verbose=True):
    masked_subnet_ip = subnet_ip + '/' + mask
    nm.scan(hosts=masked_subnet_ip, arguments='-n -sP -PE -PA21,23,80,3389')
    hosts_list = [(x, nm[x]['status']['state']) for x in nm.all_hosts()]
    if verbose:
        for i, (host, status) in enumerate(hosts_list):        
            print(host, status)
    return hosts_list


print("CHECKING: Current IP Location")
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.connect(("8.8.8.8", 80))
kali_ip = s.getsockname()[0]
print("IP Address of Kali is:", kali_ip)
s.close()

# s.getscockname()[0] is the IP Address of Kali in String

kali_ip_masked = kali_ip + "/" + SUBNET_MASK

nm = nmap.PortScanner()
# nm.scan(hosts='10.0.0.13/24', arguments='-n -sP -PE -PA21,23,80,3389')
nm.scan(hosts=kali_ip_masked, arguments='-n -sP -PE -PA21,23,80,3389')
hosts_list = [(x, nm[x]['status']['state']) for x in nm.all_hosts()]
# del hosts_list[kali_ip]

for i, (host, status) in enumerate(hosts_list): 
    if host == kali_ip:
        hosts_list.pop(i)       
#    print(host, status)
        
print(hosts_list)

## say we successfully exploited 10.0.0.1
## subnet host 1 IP Address: 10.6.6.1
## subnet host 1 IP Address: 10.80.80.1
subnet_ip_1 = '10.6.6.1'
subnet_ip_1_hosts_list = subnet_ip_scan(nm, subnet_ip=subnet_ip_1, mask=SUBNET_MASK)

nm.scan('10.6.6.1', '22-443')
print(nm.scaninfo())

for proto in nm['10.6.6.1'].all_protocols():
    print('----------')
    print('Protocol : %s' % proto)
    lport = nm['10.6.6.1'][proto].keys()
    #lport.sort()
    for port in lport:
        print ('port : %s\tstate : %s' % (port, nm['10.6.6.1'][proto][port]['state']))
        


